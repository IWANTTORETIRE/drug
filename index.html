<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中醫智慧開藥系統</title>
    <!-- 引入 Tailwind CSS 與 必要函式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        @media print { .no-print { display: none; } }
        /* 自定義捲軸 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }
        
        /* 修復 PDF 渲染問題：確保模板在背景中以正確尺寸渲染 */
        #pdf-render-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 210mm;
            z-index: -100;
            overflow: hidden;
            background: white;
            visibility: hidden;
        }
    </style>
</head>
<body class="bg-emerald-50 text-slate-800 font-sans min-h-screen">

    <!-- 頂部導航 -->
    <header class="bg-white shadow-sm no-print sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2 text-emerald-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                <h1 class="text-2xl font-bold tracking-tight">中醫智慧開藥系統</h1>
            </div>
            <nav class="flex space-x-2">
                <button onclick="switchTab('prescription')" id="tab-btn-prescription" class="px-4 py-2 rounded-md font-medium transition bg-emerald-100 text-emerald-800">處方開立</button>
                <button onclick="switchTab('inventory')" id="tab-btn-inventory" class="px-4 py-2 rounded-md font-medium transition text-slate-600 hover:bg-slate-100">藥品庫存管理</button>
            </nav>
        </div>
    </header>

    <!-- 提示訊息 -->
    <div id="notification" class="fixed top-4 right-4 p-4 rounded-md shadow-lg z-[100] flex items-center space-x-2 text-white transform translate-x-full transition-transform duration-300 hidden"></div>

    <main class="max-w-7xl mx-auto px-4 py-8 no-print">
        
        <!-- 處方開立分頁 -->
        <div id="tab-prescription" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- 左側：病患資訊區域 -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-emerald-100">
                        <h3 class="font-bold text-emerald-800 mb-4 border-b pb-2">病患資訊</h3>
                        <div class="space-y-3">
                            <input type="text" id="p-name" placeholder="病患姓名" class="w-full p-2 border rounded focus:ring-2 focus:ring-emerald-500 outline-none">
                            <div class="flex gap-2">
                                <select id="p-gender" class="w-1/2 p-2 border rounded"><option>男</option><option>女</option></select>
                                <input type="number" id="p-age" placeholder="年齡" class="w-1/2 p-2 border rounded">
                            </div>
                            <input type="date" id="p-date" class="w-full p-2 border rounded">
                            <textarea id="p-diag" placeholder="診斷 / 症狀" class="w-full p-2 border rounded" rows="2"></textarea>
                        </div>
                    </div>
                </div>

                <!-- 右側：處方設定與明細區域 (合併設定區與清單) -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- 處方設定與加藥區塊 (已移至此處) -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-emerald-100">
                        <h3 class="font-bold text-emerald-800 mb-4 border-b pb-2">處方設定與加藥</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-xs text-slate-500">服用天數</label><input type="number" id="s-days" value="7" class="w-full p-2 border rounded text-center font-bold"></div>
                                <div><label class="text-xs text-slate-500">每日次數</label><input type="number" id="s-packets" value="2" class="w-full p-2 border rounded text-center font-bold"></div>
                                <div class="col-span-2">
                                    <label class="text-xs text-slate-500">醫師姓名 (列印用)</label>
                                    <input type="text" id="s-doctor" placeholder="醫師簽章姓名" class="w-full p-2 border rounded">
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="text-xs text-slate-500">註冊編號 (列印用)</label>
                                    <input type="text" id="s-regno" placeholder="例如: 00XXXX" class="w-full p-2 border rounded">
                                </div>
                                <div class="relative">
                                    <label class="text-xs text-slate-500">搜尋並加藥</label>
                                    <div class="relative">
                                        <input type="text" id="med-search" oninput="handleSearch(this.value)" placeholder="搜尋藥品名稱或編號..." class="w-full p-2 pl-10 border border-emerald-200 rounded outline-none focus:border-emerald-500">
                                        <div class="absolute left-3 top-2.5 text-slate-400">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                                        </div>
                                    </div>
                                    <!-- 搜尋結果 -->
                                    <div id="search-results" class="absolute z-50 w-full bg-white mt-1 border rounded-lg shadow-xl max-h-60 overflow-y-auto hidden"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 處方清單區塊 -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-emerald-100 min-h-[400px] flex flex-col">
                        <h3 class="font-bold text-emerald-800 mb-4 border-b pb-2 flex justify-between">
                            <span>處方清單</span>
                            <span id="summary-header" class="text-sm font-normal text-slate-500"></span>
                        </h3>
                        <div class="flex-1 overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-50 text-xs text-slate-500 uppercase">
                                    <tr>
                                        <th class="p-3 text-left">藥品名稱</th>
                                        <th class="p-3 text-center">每日 (g)</th>
                                        <th class="p-3 text-right">總量 (g)</th>
                                        <th class="p-3 text-right">小計</th>
                                        <th class="p-3 text-center w-10"></th>
                                    </tr>
                                </thead>
                                <tbody id="selected-meds-list" class="divide-y">
                                    <!-- 動態生成 -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-6 bg-slate-800 text-white p-6 rounded-xl">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                <div><div class="text-xs text-slate-400">總天數</div><div id="calc-days" class="text-xl font-bold">0</div></div>
                                <div><div class="text-xs text-slate-400">每日總量</div><div id="calc-daily-g" class="text-xl font-bold">0 g</div></div>
                                <div><div class="text-xs text-slate-400">估算成本</div><div id="calc-cost" class="text-xl font-bold text-slate-300">$ 0</div></div>
                                <div><div class="text-xs text-emerald-400 font-bold">總售價</div><div id="calc-total" class="text-2xl font-bold text-emerald-400">$ 0</div></div>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="clearPrescription()" class="flex-1 py-2 border border-slate-600 rounded hover:bg-slate-700 transition">清空</button>
                                <button onclick="generatePDF()" class="flex-[2] py-2 bg-emerald-500 rounded font-bold hover:bg-emerald-400 transition flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                                    儲存並列印
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 庫存管理分頁 -->
        <div id="tab-inventory" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm border border-emerald-100 overflow-hidden">
                <div class="p-6 border-b border-emerald-50 bg-emerald-50/30 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-emerald-800">庫存管理</h2>
                    <label class="bg-emerald-600 text-white px-4 py-2 rounded-lg cursor-pointer hover:bg-emerald-700 transition flex items-center gap-2 shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        導入 Excel / CSV
                        <input type="file" accept=".xlsx,.xls,.csv" onchange="handleExcelImport(event)" class="hidden">
                    </label>
                </div>
                <div id="inventory-list" class="p-6 space-y-4">
                    <!-- 動態生成庫存列表 -->
                </div>
            </div>
        </div>
    </main>

    <!-- 修復：列印專用渲染區 -->
    <div id="pdf-render-container">
        <div id="pdf-template" class="bg-white text-black p-10 font-sans" style="width: 210mm;">
            <h1 class="text-3xl font-bold text-center mb-10 tracking-widest">中醫處方箋</h1>
            
            <div class="grid grid-cols-3 gap-4 border-b-2 border-black pb-4 mb-8 text-lg">
                <p><strong>姓名：</strong><span id="pdf-p-name"></span></p>
                <p><strong>性別：</strong><span id="pdf-p-gender"></span></p>
                <p><strong>日期：</strong><span id="pdf-p-date"></span></p>
                <p class="col-span-3"><strong>診斷：</strong><span id="pdf-p-diag"></span></p>
            </div>

            <div class="min-h-[450px]">
                <h3 class="text-xl font-bold mb-4">中醫濃縮顆粒處方：</h3>
                <div id="pdf-meds-grid" class="grid grid-cols-2 gap-y-4 gap-x-10 text-lg">
                    <!-- 藥品會在此處填充 -->
                </div>
            </div>

            <div class="mt-10 border-t-2 border-gray-200 pt-6 space-y-3 text-lg">
                <p id="pdf-instructions" class="font-bold"></p>
                <div class="space-y-1 text-gray-700">
                    <p><strong>醫囑：</strong>中藥需與其他藥物或補充品相隔最少 2 小時服用。</p>
                    <p><strong>禁忌：</strong>服藥期間忌煎炸油膩、辛辣生冷之品。若有不適請立即停藥並諮詢醫師。</p>
                </div>
            </div>

            <div class="mt-16 flex justify-end pr-10">
                <div class="text-right border-t border-black pt-4 min-w-[200px] space-y-1">
                    <p class="text-lg"><strong>處方醫師：</strong><span id="pdf-doctor-name"></span></p>
                    <p class="text-sm text-gray-600"><strong>註冊編號：</strong><span id="pdf-doctor-reg"></span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- 腳本邏輯 -->
    <script>
        // --- 狀態管理 ---
        let catalogues = JSON.parse(localStorage.getItem('tcm_catalogues') || '[]');
        let selectedMeds = [];
        let activeTab = 'prescription';

        // --- 初始化 ---
        window.onload = () => {
            document.getElementById('p-date').valueAsDate = new Date();
            renderInventory();
            updateCalculations();
        };

        // --- 功能：分頁切換 ---
        function switchTab(tabId) {
            activeTab = tabId;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('bg-emerald-100', 'text-emerald-800');
                btn.classList.add('text-slate-600');
            });
            const activeBtn = document.getElementById(`tab-btn-${tabId}`);
            activeBtn.classList.add('bg-emerald-100', 'text-emerald-800');
        }

        // --- 功能：提示訊息 ---
        function notify(msg, type = 'success') {
            const el = document.getElementById('notification');
            el.innerText = msg;
            el.className = `fixed top-4 right-4 p-4 rounded-md shadow-lg z-[100] flex items-center space-x-2 text-white transform transition-transform duration-300 ${type === 'error' ? 'bg-red-500' : 'bg-emerald-500'}`;
            el.classList.remove('hidden', 'translate-x-full');
            setTimeout(() => {
                el.classList.add('translate-x-full');
                setTimeout(() => el.classList.add('hidden'), 300);
            }, 3000);
        }

        // --- 功能：Excel / CSV 導入 ---
        function handleExcelImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const dataArr = evt.target.result;
                    const wb = XLSX.read(dataArr, { type: 'binary' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(ws);

                    if (data.length === 0) return notify('檔案內容為空', 'error');

                    const manufacturer = prompt('請輸入藥廠或列表名稱：', file.name.split('.')[0]) || '未命名藥廠';
                    
                    const newCat = {
                        id: Date.now(),
                        manufacturer: manufacturer,
                        date: new Date().toISOString().split('T')[0],
                        medicines: data.map((row, i) => ({
                            uid: `${Date.now()}-${i}`,
                            id: row['編號'] || row['ID'] || row['代碼'] || i + 1,
                            name: row['藥品名稱'] || row['名稱'] || row['Name'] || '未知藥品',
                            concentration: row['濃度'] || row['參考濃度'] || '-',
                            cost: parseFloat(row['成本'] || row['Cost'] || 0),
                            price: parseFloat(row['售價'] || row['Price'] || row['價格'] || 0)
                        }))
                    };

                    catalogues.unshift(newCat);
                    localStorage.setItem('tcm_catalogues', JSON.stringify(catalogues));
                    renderInventory();
                    notify(`成功導入「${manufacturer}」，共 ${newCat.medicines.length} 筆藥品`);
                } catch (err) {
                    notify('解析檔案失敗，請檢查格式是否正確', 'error');
                }
            };
            reader.readAsBinaryString(file);
            e.target.value = '';
        }

        // --- 功能：渲染庫存 ---
        function renderInventory() {
            const list = document.getElementById('inventory-list');
            if (catalogues.length === 0) {
                list.innerHTML = `<div class="text-center py-10 text-slate-400">尚無庫存資料，請點擊右上方導入</div>`;
                return;
            }

            list.innerHTML = catalogues.map(cat => `
                <div class="flex items-center justify-between p-4 border rounded-lg hover:bg-slate-50 transition shadow-sm">
                    <div>
                        <h4 class="font-bold text-emerald-700 text-lg">${cat.manufacturer}</h4>
                        <p class="text-sm text-slate-500">導入日期: ${cat.date} | 藥品數量: ${cat.medicines.length}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="deleteCatalogue(${cat.id})" class="text-red-400 hover:bg-red-50 p-2 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function deleteCatalogue(id) {
            if (!confirm('確定要刪除此藥廠列表嗎？')) return;
            catalogues = catalogues.filter(c => c.id !== id);
            localStorage.setItem('tcm_catalogues', JSON.stringify(catalogues));
            renderInventory();
            notify('已刪除列表');
        }

        // --- 功能：處方搜尋 ---
        function handleSearch(query) {
            const resultsDiv = document.getElementById('search-results');
            if (!query.trim()) {
                resultsDiv.classList.add('hidden');
                return;
            }

            const allMeds = catalogues.flatMap(cat => cat.medicines.map(m => ({...m, manufacturer: cat.manufacturer})));
            const q = query.toLowerCase();
            const filtered = allMeds.filter(m => 
                m.name.includes(q) || String(m.id).includes(q)
            ).slice(0, 15);

            if (filtered.length > 0) {
                resultsDiv.innerHTML = filtered.map(m => `
                    <div onclick="addMed('${m.uid}')" class="p-3 hover:bg-emerald-50 cursor-pointer border-b last:border-0 flex justify-between items-center">
                        <div>
                            <div class="font-bold">${m.name}</div>
                            <div class="text-xs text-slate-500">${m.manufacturer} | 編號: ${m.id}</div>
                        </div>
                        <div class="text-emerald-600 font-bold">$${m.price}/100g</div>
                    </div>
                `).join('');
                resultsDiv.classList.remove('hidden');
            } else {
                resultsDiv.innerHTML = `<div class="p-4 text-center text-slate-400">找不到藥品</div>`;
                resultsDiv.classList.remove('hidden');
            }
        }

        function addMed(uid) {
            if (selectedMeds.some(m => m.uid === uid)) return notify('藥品已在清單中', 'error');
            const allMeds = catalogues.flatMap(cat => cat.medicines.map(m => ({...m, manufacturer: cat.manufacturer})));
            const med = allMeds.find(m => m.uid === uid);
            selectedMeds.push({ ...med, dailyDosage: 1 });
            document.getElementById('med-search').value = '';
            document.getElementById('search-results').classList.add('hidden');
            renderSelectedMeds();
            updateCalculations();
        }

        function renderSelectedMeds() {
            const list = document.getElementById('selected-meds-list');
            const days = parseInt(document.getElementById('s-days').value) || 0;
            list.innerHTML = selectedMeds.map(med => {
                const totalG = (med.dailyDosage * days).toFixed(1);
                const subtotal = Math.round(totalG * (med.price / 100));
                return `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="p-3">
                            <div class="font-bold text-slate-800">${med.name}</div>
                            <div class="text-xs text-slate-400">${med.manufacturer} [${med.concentration}]</div>
                        </td>
                        <td class="p-3">
                            <input type="number" step="0.5" value="${med.dailyDosage}" onchange="updateMedDosage('${med.uid}', this.value)" 
                                class="w-20 p-1 border rounded text-center focus:ring-1 focus:ring-emerald-500">
                        </td>
                        <td class="p-3 text-right text-slate-600 font-mono">${totalG} g</td>
                        <td class="p-3 text-right font-bold text-emerald-600 font-mono">$ ${subtotal}</td>
                        <td class="p-3 text-center">
                            <button onclick="removeMed('${med.uid}')" class="text-red-300 hover:text-red-500 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateMedDosage(uid, val) {
            const med = selectedMeds.find(m => m.uid === uid);
            if (med) med.dailyDosage = parseFloat(val) || 0;
            renderSelectedMeds();
            updateCalculations();
        }

        function removeMed(uid) {
            selectedMeds = selectedMeds.filter(m => m.uid !== uid);
            renderSelectedMeds();
            updateCalculations();
        }

        function updateCalculations() {
            const days = parseInt(document.getElementById('s-days').value) || 0;
            const packets = document.getElementById('s-packets').value;
            let dailyG = 0, total = 0, totalCost = 0;

            selectedMeds.forEach(m => {
                const totalGrams = m.dailyDosage * days;
                dailyG += m.dailyDosage;
                total += totalGrams * (m.price / 100);
                totalCost += totalGrams * (m.cost / 100);
            });

            document.getElementById('calc-days').innerText = days;
            document.getElementById('calc-daily-g').innerText = `${dailyG.toFixed(1)} g`;
            document.getElementById('calc-cost').innerText = `$ ${Math.round(totalCost)}`;
            document.getElementById('calc-total').innerText = `$ ${Math.round(total)}`;
            document.getElementById('summary-header').innerText = `總共 ${days} 天 | 每日 ${packets} 次`;
        }

        document.getElementById('s-days').oninput = () => { renderSelectedMeds(); updateCalculations(); };
        document.getElementById('s-packets').oninput = () => updateCalculations();

        function clearPrescription() {
            if (!confirm('確定要清空當前處方嗎？')) return;
            selectedMeds = [];
            document.getElementById('p-name').value = '';
            document.getElementById('p-diag').value = '';
            renderSelectedMeds();
            updateCalculations();
        }

        // --- 功能：生成 PDF (修復截斷問題) ---
        async function generatePDF() {
            const name = document.getElementById('p-name').value;
            if (!name) return notify('請輸入病患姓名', 'error');
            if (selectedMeds.length === 0) return notify('請先加入藥品', 'error');

            const days = document.getElementById('s-days').value;
            const packets = document.getElementById('s-packets').value;
            const docName = document.getElementById('s-doctor').value;
            const regNo = document.getElementById('s-regno').value;

            // 填充 PDF 模板
            document.getElementById('pdf-p-name').innerText = name;
            document.getElementById('pdf-p-gender').innerText = document.getElementById('p-gender').value;
            document.getElementById('pdf-p-date').innerText = document.getElementById('p-date').value;
            document.getElementById('pdf-p-diag').innerText = document.getElementById('p-diag').value || '未註明';
            document.getElementById('pdf-instructions').innerText = `用法：沖服 ${days} 天，每天 ${packets} 次，每次 1 包，合共 ${days * packets} 包，建議飯後服用。`;
            document.getElementById('pdf-doctor-name').innerText = docName || '________________';
            document.getElementById('pdf-doctor-reg').innerText = regNo || '________________';

            const grid = document.getElementById('pdf-meds-grid');
            grid.innerHTML = selectedMeds.map(m => `
                <div class="flex justify-between border-b border-dotted border-gray-400 pb-1">
                    <span class="font-medium">${m.name} <small class="text-gray-500 text-xs">(${m.manufacturer})</small></span>
                    <span class="font-mono">${m.dailyDosage} g</span>
                </div>
            `).join('');

            // 強制設定渲染容器為可見狀態，html2pdf 抓取完會自動還原
            const container = document.getElementById('pdf-render-container');
            container.style.visibility = 'visible';

            const element = document.getElementById('pdf-template');
            const opt = {
                margin: 0,
                filename: `處方_${name}_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true,
                    scrollY: 0, // 重要：強制座標從 0 開始，避免因頁面捲動導致截斷
                    scrollX: 0,
                    windowHeight: element.offsetHeight // 強制視窗高度等於元素高度
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            notify('正在生成 PDF，請稍候...');
            try {
                await html2pdf().set(opt).from(element).save();
                notify('PDF 已成功生成並下載');
            } catch (err) {
                console.error(err);
                notify('PDF 生成失敗', 'error');
            } finally {
                container.style.visibility = 'hidden';
            }
        }
    </script>
</body>
</html>
